
### 任务目标
根据老用户的兴趣、浏览行为为老用户推荐他可能购买的产品： YouTube 2016推荐系统主要用于召回阶段的排序

### 核心技术
YouTube2016的深度学习召回框架；构造正负样本


基于YouTube2016的论文开发出召回框架，
特征工程
* 历史兴趣提取
选择距今最近的50个movie_id作为用户行为句子，得到每个movie_id的embedding后，进行SumPooling，得到用户的平均喜好
* 构建正负样本
按照 正：负 = 1:10 的比例构建用户观看movie_id的兴趣：

正样本：用户看过的电影序列 hist_movie_id[2692, 1094,  969, ...,    0,    0,    0] 和 movie_id

负样本：在推荐系统的电影池中随机选择用户没看过的10个movie_id

增加的Pooling策略：输入一个向量，输出同等维度的向量
* Self-Attention：也可以让输入的向量之间都有彼此的信息，若把 q·k 的结果视为一张皮尔森相关性系数表（注意力矩阵），就可以让模型知道内容的重要性顺序。
* 给用户点击行为句子增加非线性特征

Faiss召回top-n的效果：
测试集中user_id召回top-k个正确的情况

参数量：912545 --> 102786

未来的特征工程：
* 构建时间差，增加example_age特征

* 使用用户评分rating作为权重给上述用户行为句子 hist_movie_id 做加权，也就是让每部电影的Embedding在每个用户那里都不同，因为用户对该电影的显式隐式行为行为不同
用户行为句子改变权重的思路是Caser召回模型，用户行为句子hist_movie_id 的最后一个movieID超级重要，应该作为单独特征喂给模型，实际上这是赋予最后一个movieID n倍的权重，因为在hist_movie_id中每个movieID的权重为1/n(n为hist_movie_id的长度)

* 借鉴双塔模型，构建user Tower 和 item Tower，分布式储存对工程更友好


tf.version == '2.1.0'
运行顺序
* data.py
* train.py
* load_youtube_model_to_predict.py
* faiss_evaluate.py

# 效果说明


__________________________________________________________________________________________________
Layer (type)                    Output Shape         Param #     Connected to                     
==================================================================================================
user_click_item_seq_input_layer [(None, 50)]         0                                            
__________________________________________________________________________________________________
user_id_input_layer (InputLayer [(None, 1)]          0                                            
__________________________________________________________________________________________________
gender_input_layer (InputLayer) [(None, 1)]          0                                            
__________________________________________________________________________________________________
age_input_layer (InputLayer)    [(None, 1)]          0                                            
__________________________________________________________________________________________________
occupation_input_layer (InputLa [(None, 1)]          0                                            
__________________________________________________________________________________________________
zip_input_layer (InputLayer)    [(None, 1)]          0                                            
__________________________________________________________________________________________________
item_id_embedding_layer (Embedd multiple             237248      pos_item_sample_input_layer[0][0]
                                                                 neg_item_sample_input_layer[0][0]
                                                                 user_click_item_seq_input_layer[0
__________________________________________________________________________________________________
user_click_item_seq_length_inpu [(None, 1)]          0                                            
__________________________________________________________________________________________________
user_id_embedding_layer (Embedd (None, 1, 64)        386624      user_id_input_layer[0][0]        
__________________________________________________________________________________________________
gender_embedding_layer (Embeddi (None, 1, 64)        192         gender_input_layer[0][0]         
__________________________________________________________________________________________________
age_embedding_layer (Embedding) (None, 1, 64)        512         age_input_layer[0][0]            
__________________________________________________________________________________________________
occupation_embedding_layer (Emb (None, 1, 64)        1408        occupation_input_layer[0][0]     
__________________________________________________________________________________________________
zip_embedding_layer (Embedding) (None, 1, 64)        220160      zip_input_layer[0][0]            
__________________________________________________________________________________________________
sequence_pooling_layer_55 (Sequ (None, 1, 64)        0           item_id_embedding_layer[2][0]    
                                                                 user_click_item_seq_length_input_
__________________________________________________________________________________________________
concatenate_133 (Concatenate)   (None, 1, 384)       0           user_id_embedding_layer[0][0]    
                                                                 gender_embedding_layer[0][0]     
                                                                 age_embedding_layer[0][0]        
                                                                 occupation_embedding_layer[0][0] 
                                                                 zip_embedding_layer[0][0]        
                                                                 sequence_pooling_layer_55[0][0]  
__________________________________________________________________________________________________
tf_op_layer_Tile_2 (TensorFlowO [(None, 5, 384)]     0           concatenate_133[0][0]            
__________________________________________________________________________________________________
capsule_layer_58 (CapsuleLayer) (None, 5, 64)        4346        item_id_embedding_layer[2][0]    
                                                                 user_click_item_seq_length_input_
__________________________________________________________________________________________________
concatenate_134 (Concatenate)   (None, 5, 448)       0           tf_op_layer_Tile_2[0][0]         
                                                                 capsule_layer_58[0][0]           
__________________________________________________________________________________________________
FC_1 (Dense)                    (None, 5, 128)       57472       concatenate_134[0][0]            
__________________________________________________________________________________________________
pos_item_sample_input_layer (In [(None, 1)]          0                                            
__________________________________________________________________________________________________
neg_item_sample_input_layer (In [(None, 10)]         0                                            
__________________________________________________________________________________________________
FC_2 (Dense)                    (None, 5, 64)        8256        FC_1[0][0]                       
__________________________________________________________________________________________________
label_aware_attention_43 (Label (None, 64)           0           FC_2[0][0]                       
                                                                 item_id_embedding_layer[0][0]    
                                                                 user_click_item_seq_length_input_
__________________________________________________________________________________________________
concatenate_135 (Concatenate)   (None, 11, 64)       0           item_id_embedding_layer[0][0]    
                                                                 item_id_embedding_layer[1][0]    
__________________________________________________________________________________________________
tf_op_layer_ExpandDims_7 (Tenso [(None, 1, 64)]      0           label_aware_attention_43[0][0]   
__________________________________________________________________________________________________
tf_op_layer_transpose_34 (Tenso [(None, 64, 11)]     0           concatenate_135[0][0]            
__________________________________________________________________________________________________
tf_op_layer_MatMul_29 (TensorFl [(None, 1, 11)]      0           tf_op_layer_ExpandDims_7[0][0]   
                                                                 tf_op_layer_transpose_34[0][0]   
__________________________________________________________________________________________________
tf_op_layer_Softmax_29 (TensorF [(None, 1, 11)]      0           tf_op_layer_MatMul_29[0][0]      
==================================================================================================
Total params: 916,218
Trainable params: 915,968
Non-trainable params: 250
__________________________________________________________________________________________________
None
